# ============================================
# Town of Salem - Nginx Config para Portainer
# Dominio: salem.xelements.es
# ============================================
# Instrucciones:
#   1. Copia este archivo a tu nginx de Portainer
#   2. El SSL ya lo gestiona tu nginx existente
#   3. Asegúrate de que los puertos 3000 y 3001 estén accesibles
# ============================================

# IMPORTANTE: Este bloque va DENTRO de tu server {} existente para salem.xelements.es
# NO copies la parte de "server {" si ya tienes un bloque configurado

# --- Socket.IO / WebSocket (DEBE ir antes de /api) ---
location /socket.io/ {
    proxy_pass http://localhost:3001;
    proxy_http_version 1.1;

    # WebSocket upgrade headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket timeouts (24h keep alive)
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;

    # Disable buffering for real-time
    proxy_buffering off;
    proxy_cache off;
}

# --- Backend API ---
location /api/ {
    proxy_pass http://localhost:3001;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Timeouts
    proxy_read_timeout 30s;
    proxy_connect_timeout 10s;
}

# --- Health check (directo al backend) ---
location /health {
    proxy_pass http://localhost:3001;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}

# --- Frontend (Next.js) DEBE IR AL FINAL ---
location / {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Next.js HMR WebSocket (opcional)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# Gzip compression (opcional si ya lo tienes global)
gzip on;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;
gzip_min_length 1000;

# Max upload size
client_max_body_size 10M;
